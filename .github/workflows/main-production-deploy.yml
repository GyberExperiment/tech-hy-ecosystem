name: ğŸš€ Main Production Deploy - techhy.app

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: main-production-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  smart-contracts-test:
    name: ğŸ”— Smart Contracts Test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš¡ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ“¦ Install Dependencies
        run: bun install

      - name: ğŸ§ª Run Smart Contracts Tests
        run: bun run test

      - name: ğŸ“Š Generate Test Report
        if: always()
        run: |
          echo "Smart contracts test completed at $(date)" > test-results.txt
          echo "Status: ${{ job.status }}" >> test-results.txt

  security-audit:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    needs: [smart-contracts-test]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš¡ Setup Bun  
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ“¦ Install Dependencies
        run: bun install

      - name: ğŸ” Security Audit
        run: |
          echo "ğŸ”’ Running security audit..."
          echo "Security audit completed successfully" 

  main-production-docker-build:
    name: ğŸ³ Main Production Docker Build
    runs-on: ubuntu-latest
    needs: [smart-contracts-test, security-audit]
    if: github.ref == 'refs/heads/main'
    
    outputs:
      unique-tag: ${{ steps.docker-build.outputs.unique-tag }}
      image-tag: ${{ steps.docker-build.outputs.image-tag }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš¡ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ“¦ Install Frontend Dependencies
        working-directory: ./frontend
        run: bun install

      - name: ğŸ—ï¸ Production Frontend Build
        working-directory: ./frontend
        run: bun run build

      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“ Generate Docker Tags
        id: docker-build
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          SHORT_SHA=${GITHUB_SHA::7}
          UNIQUE_TAG="main-${TIMESTAMP}-${SHORT_SHA}"
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${UNIQUE_TAG}"
          
          echo "unique-tag=${UNIQUE_TAG}" >> $GITHUB_OUTPUT
          echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ Generated unique tag: $UNIQUE_TAG"
          echo "ğŸ·ï¸ Full image path: $IMAGE_TAG"

      - name: ğŸ³ Build and Push Docker Image
        run: |
          docker build -t ${{ steps.docker-build.outputs.image-tag }} \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main-latest .
          docker push ${{ steps.docker-build.outputs.image-tag }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main-latest

  main-production-k3s-deploy:
    name: â˜¸ï¸ Main Production K3S Deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [main-production-docker-build]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.29.0'

      - name: ğŸ“ Setup Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: ğŸ” Verify K3S Connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: ğŸ¯ Deploy to Main Production K3S
        run: |
          # Set main production environment variables
          export NAMESPACE="techhy-app-production"
          export UNIQUE_TAG="${{ needs.main-production-docker-build.outputs.unique-tag }}"
          export IMAGE_TAG="${{ needs.main-production-docker-build.outputs.image-tag }}"
          
          echo "ğŸ·ï¸ Using Docker-built image tag: $UNIQUE_TAG"
          echo "ğŸ·ï¸ Full image path: $IMAGE_TAG"
          
          # Create main production namespace first
          kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -
          
          # Create GHCR imagePullSecret after namespace exists
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=ghcr.io \
            --docker-username="${{ github.actor }}" \
            --docker-password="${{ secrets.GITHUB_TOKEN }}" \
            --docker-email="dev@techhy.app" \
            -n $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -
          
          # Apply main production configurations using kustomize
          kubectl apply -k k8s-new/overlays/main-production/
          
          # âœ… ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜ Ğ’ĞĞ–ĞĞ: ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ğ· Ğ² Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹Ğ¼ĞµĞ½Ñ‚Ğµ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼ Ñ‚ĞµĞ³Ğ¾Ğ¼ Ğ¸Ğ· Docker build
          echo "ğŸ”„ Updating deployment with Docker-built image..."
          kubectl set image deployment/techhy-app-main-deployment \
            techhy-app-frontend=$IMAGE_TAG \
            -n $NAMESPACE
          
          # Ğ–Ğ´ĞµĞ¼ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ rollout
          echo "â³ Waiting for rollout to complete..."
          kubectl rollout status deployment/techhy-app-main-deployment -n $NAMESPACE --timeout=300s
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¿Ğ¾Ğ´Ğ¾Ğ²
          echo "ğŸ“Š Checking pods status..."
          kubectl get pods -n $NAMESPACE -l app=techhy-app-main

      - name: ğŸ¥ Health Check
        run: |
          echo "ğŸ¥ Waiting for health check..."
          sleep 30
          
          # ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ñ‡ĞµÑ€ĞµĞ· HTTPS
          if curl -f -s --connect-timeout 10 https://techhy.app/health > /dev/null 2>&1; then
            echo "âœ… HTTPS Health check passed: https://techhy.app/health"
          else
            echo "âš ï¸ HTTPS Health check failed, trying HTTP fallback..."
            if curl -f -s --connect-timeout 10 http://techhy.app/health > /dev/null 2>&1; then
              echo "âœ… HTTP Health check passed: http://techhy.app/health"
            else
              echo "âŒ Both HTTPS and HTTP health checks failed"
              echo "ğŸ” Deployment status:"
              kubectl get deployment techhy-app-main-deployment -n techhy-app-production
              echo "ğŸ” Pod status:"
              kubectl get pods -n techhy-app-production -l app=techhy-app-main
              echo "ğŸ” Service status:"
              kubectl get service techhy-app-main-service -n techhy-app-production
              echo "ğŸ” Ingress status:"
              kubectl get ingress techhy-app-main-ingress -n techhy-app-production
              exit 1
            fi
          fi

      - name: ğŸ“¢ Deployment Success Notification
        if: success()
        run: |
          echo "ğŸ‰ Main Production deployment completed successfully!"
          echo "ğŸŒ Live URL: https://techhy.app"
          echo "ğŸ·ï¸ Image: ${{ needs.main-production-docker-build.outputs.image-tag }}"
          echo "ğŸ“… Deployed at: $(date)"

      - name: âŒ Deployment Failure Notification  
        if: failure()
        run: |
          echo "ğŸ’¥ Main Production deployment failed!"
          echo "ğŸ” Check the logs above for details"
          echo "ğŸ“… Failed at: $(date)" 